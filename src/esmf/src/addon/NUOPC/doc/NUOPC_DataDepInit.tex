% $Id$
%

\label{DataDepInit}

For multi-model applications it is not uncommon that during start-up one or more components depends on data from one or more other components. These types of data-dependencies during initialize can become very complex very quickly. Finding the "correct" sequence to initialize all components for a complex dependency graph is not trivial. The NUOPC Layer deals with this issue by repeatedly looping over all components that indicate that their initialization has data dependencies on other components. The loop is finally exited when either all components have indicated completion of their initialization, or a dead-lock situation is being detected by the NUOPC Layer.

The data-dependency resolution loop is implemented as part of Initialize Phase Definition version 2 (IPDv02) as defined in section \ref{IPD}. Participating components communicate their current status to the NUOPC Layer via Field and Component metadata. Participants are those components that contain an {\tt IPDv02p5} assignment in their {\tt InitializePhaseMap} Attribute according to sections \ref{DriverCompMeta}, \ref{ModelCompMeta}, \ref{MediatorCompMeta}, and \ref{ConnectorCompMeta}. 

Every time a component's {\tt IPDv02p5} initialization phase is called it is responsible for setting the {\tt InitializeDataComplete} and {\tt InitializeDataProgress} Attributes according to its current status before returning. For convenience, the NUOPC Layer provides a generic implementation of an {\tt IPDv02p5} phase initialize method for Models and Mediators (available as ESMF Initialize phase 5). This generic implementation takes care of setting the {\tt InitializeDataProgress} Attribute automatically. It does so by inspecting the {\tt Updated} Field Attribute (see section \ref{FieldMeta}) on all the Fields in the component's exportState. The generic {\tt IPDv02p5} implementation must be specialized by attaching a method for specialization point {\tt label\_DataInitialize}. This specialization method is responsible for checking the Fields in the importState and for initializing any internal data structures and Fields in the exportState. Fields that are fully initialized in the exportState must be indicated by setting their {\tt Updated} Attribute to "true". Once the component is fully initialized it must further set its {\tt InitializeDataComplete} Attribute to "true" before returning.

During the execution of the data-dependency resolution loop the NUOPC Layer calls all of the Connectors {\em to} a Model/Mediator component before calling the component's {\tt IPDv02p5} method. Doing so ensures that all the currently available Fields are passed to the component before it tries to access them during {\tt IPDv02p5}. Once a component has set its {\tt InitializeDataComplete} Attribute to "true" it, and the Connectors to it, will no longer be called during the remainder of the resolution loop. 

When {\em all} of the components with an {\tt IPDv02p5} initialization phase have set their {\tt InitializeDataComplete} Attribute to "true", the NUOPC Layer successfully exits the data-dependency resolution loop. The loop is also interrupted before all {\tt InitializeDataComplete} Attributes are set to "true" if a full cycle completes without any indicated progress. The NUOPC Layer flags this situation as a potential dead-lock and returns with error.
